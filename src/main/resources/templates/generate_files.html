<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/styles.css}" href="../static/css/styles.css" />
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/style1.css}" href="../static/css/style1.css" />
    <style>
        /* EXISTING loader */
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            margin-top: 40px;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* DQI POPUP */
        #dqiModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #dqiModalContent {
            background: #ffffff;
            padding: 25px;
            border-radius: 6px;
            text-align: center;
            min-width: 300px;
        }

        /* IMPORTANT FIX: keep DQI button visible inside popup */
        #dqiModal .dqi_button {
            position: static !important;
            top: auto !important;
            left: auto !important;
        }
    </style>
</head>
<body>
<div id="header">
    <img th:src="@{/images/logo.png}" src="../static/images/logo.png" alt="Your Logo">
</div>
<div id="content4">
    <h1>Seamless CICs Compliance:<br>
        Precision in Every Submission File</h1>
    <p>Efficiently organize bank data to meet CICs standards by dividing it into utility<br>
        tables. This systematic division ensures seamless compliance and facilitates<br>
        streamlined access for optimal reporting and analysis. Enhance data<br>
        organization and responsiveness to regulatory requirements with our tailored<br>
        utility table structure.</p>
</div>
<div class="ButtonContainer">
    <button onclick="runJar()" class="runJar">Transactional Files</button>
    <button onclick="runJarBackup()" class="runJarBackup">Complete Files</button>
    <button onclick="openAnotherPage()" class="openPage">Upload New csv</button>
    <div>
        <form th:action="@{/call-procedures}" method="post">
            <button type="submit" class="reportbutton">Management Report</button>
        </form>
    </div>
    <div>
        <!-- ================= GENERATE REPORT ================= -->
        <form th:action="@{/reportDQI}" method="get">
            <button type="submit" class="dqireportbutton">
                Collective DQI
            </button>
        </form>
    </div>
    <div>
        <button onclick="tudfToExcel()" class="tudf_button">TUDF To Excel</button>
    </div>

</div>
<div class="GenerateReportButton">
    <a href="#" onclick="generateReport(); return false;" class="generateReport" style="display: none">Generate Report >></a>
</div>



<div th:if="${successMessage}" class="success-message">
    <p th:text="${successMessage}"></p>
    <script>
        setTimeout(function() {
            window.location.href = '/report'; // Redirect to report.html after 3 seconds
        }, 2000); // Adjust the delay time as needed
    </script>
</div>

<div th:if="${successMessage}" class="success-message">
    <p th:text="${successMessage}"></p>
    <script>
        setTimeout(function() {
            window.location.href = '/home';
        }, 2000);
    </script>
</div>

<!-- Display error message if present -->
<div th:if="${errorMessage}" class="error-message">
    <p th:text="${errorMessage}"></p>
</div>

<!-- Div for success or error message -->
<div id="message" style="position: fixed; bottom: 0; left: 0; width: 100%; background-color:none ; color:#FFFFFF; text-align: center; padding: 10px; font-size: 20px;"></div>

<!-- Loader -->
<div id="loader" style="display: none;"></div>

<!-- DQI CONFIRMATION POPUP -->
<div id="dqiModal">
    <div id="dqiModalContent">
        <p><strong>Choose Action</strong></p>
        <br>

        <button onclick="generateDQIFromPopup()" class="dqi_button">
            Generate DQI
        </button>

        <br><br>

        <button onclick="generateReportFromPopup()" class="generateReport">
            Generate Report
        </button>

        <br><br>

        <button onclick="closeDQIModal()" class="runJarBackup">
            Cancel
        </button>
    </div>
</div>

<script>
    /* ORIGINAL DQI LOGIC — UNCHANGED */
    document.getElementById('submitButton').addEventListener('click', function(event) {
        event.preventDefault();

        document.getElementById('loader').style.display = 'block';

        setTimeout(function() {
            document.getElementById('loader').style.display = 'none';

            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/getMessage', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    document.getElementById('message').innerText = xhr.responseText;
                    document.getElementById('message').style.display = 'block';

                    setTimeout(function() {
                        window.location.href = '/home';
                    }, 5000);
                }
            };
            xhr.send();
        }, 3000);
    });

    /* TRANSACTIONAL FILES */
    function runJar() {
        callApi('/api/run-jar');
    }

    /* COMPLETE FILES */
    function runJarBackup() {
        callApi('/api/run-jar-backup');
    }

    function callApi(url) {
        const loader = document.getElementById('loader');
        const message = document.getElementById('message');

        loader.style.display = 'block';

        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                loader.style.display = 'none';

                if (xhr.status === 200) {

                    // ✅ SHOW SUCCESS MESSAGE FIRST
                    message.innerHTML = xhr.responseText;
                    message.style.display = 'block';

                    // ✅ FORCE BROWSER TO PAINT MESSAGE
                    requestAnimationFrame(() => {
                        // ✅ OPEN POPUP AFTER DELAY
                        setTimeout(() => {
                            document.getElementById('dqiModal').style.display = 'flex';
                        }, 2000);
                    });

                } else {
                    message.innerHTML = 'Error: ' + xhr.responseText;
                    message.style.display = 'block';
                }
            }
        };
        xhr.send();
    }

    /* REUSE DQI BUTTON LOGIC */
    function generateDQIFromPopup() {
    closeDQIModal();

    const loader = document.getElementById('loader');
    const message = document.getElementById('message');

    loader.style.display = 'block';

    // ⏳ same 3 sec delay as previous
    setTimeout(function () {
        loader.style.display = 'none';

        const xhr = new XMLHttpRequest();
        xhr.open('GET', '/getMessage', true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                message.innerText = xhr.responseText;
                message.style.display = 'block';

                // ⏳ same redirect delay (5 sec)
                setTimeout(function () {
                    window.location.href = '/home';
                }, 5000);
            }
        };
        xhr.send();
    }, 3000);
}


    function closeDQIModal() {
        document.getElementById('dqiModal').style.display = 'none';
    }

function generateReport() {
    // Display loader
    document.getElementById('loader').style.display = 'block';

    // Send an HTTP request to the server to generate the report
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/generateReport', true);
    xhr.responseType = 'blob'; // Set response type to Blob

    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
            // Hide the loader
            document.getElementById('loader').style.display = 'none';

            if (xhr.status === 200) {
                // Create a Blob from the response
                var blob = new Blob([xhr.response], { type: 'text/csv' });

                // Create an anchor element
                var a = document.createElement('a');
                // Set the href attribute to the URL of the Blob
                a.href = window.URL.createObjectURL(blob);

                // Get current date and time
                var currentDate = new Date();
                var formattedDate = currentDate.toISOString().slice(0,10);
                var formattedTime = currentDate.toTimeString().slice(0,8).replace(/:/g, "-");

                // Set the download attribute to include date and time in the filename
                a.download = 'status_report_' + formattedDate + '_' + formattedTime + '.csv';

                // Click the anchor element to trigger the download
                a.click();
                // Release the URL object to free up resources
                window.URL.revokeObjectURL(a.href);

                // Display success message
                document.getElementById('message').innerHTML = 'Status Report Downloaded successfully!';
            } else {
                // Display an error message on the screen
                document.getElementById('message').innerHTML = 'Error: Failed to generate report. Please try again.';
            }
        }
    };
    xhr.send();
}

    function generateReportFromPopup() {
    generateReport();
}

    function tudfToExcel() {
        window.location.href = '/tudfToExcel';
    }

    function openAnotherPage() {
        window.location.href = 'csv_to_db';
    }
</script>
</body>
</html>

